let db



//team assignment.
app.post("/api/teams/:teamId/assign",authMiddleware,async (request,response)=>{
    const {orgId,userId}=request.user
    const {teamId}=request.params
    const {employeeId}=request.body
    
       if (!employeeId) {
      return response.status(400).send({ message: "No employee ID provided" });
    }
    const insertIdQuery="INSERT INTO employee_teams (employee_id,team_id) values (?,?)"
   
        await db.query(insertIdQuery,[employeeId,teamId])
    
    const action="assigned_employee_to_team"
    const meta={
        employee_id:employeeId,
        team_id:teamId
    }
    await addLog(orgId,userId,action,meta)
      response.send({
      message: "Employees assigned to team successfully",
      assignedEmployee: employeeId,
    });
})

//delete team assignment
app.delete("/api/teams/:teamId/unassign",authMiddleware,async (request,response)=>{
    const {teamId}=request.params
    const {orgId,userId}=request.user
    const {employeeIds,employeeId}=request.body
    const ids = employeeIds || (employeeId ? [employeeId] : []);
     if (ids.length === 0) {
      return res.status(400).send({ message: "No employee IDs provided" });
    }
    const deleteQuery = "DELETE FROM employee_teams WHERE team_id=? AND employee_id=?";
     for (const empId of ids) {
    await db.query(deleteQuery, [teamId, empId]);
  }
  const action = "unassigned_employee_from_team";
  const meta = {
    employeeId: ids,
    teamId,
  };
    await addLog(orgId, userId, action, meta);

  response.send({
    message: "Employees unassigned from team successfully",
    unassignedEmployees: ids,
  });
})

//display logs.
app.get("/api/logs", authMiddleware, async (request, response) => {
    const { orgId } = request.user;
    const { userId, action, startDate, endDate } = request.query;

    let query = "SELECT * FROM logs WHERE organisation_id=?";
    const params = [orgId];

    if (userId) {
        query += " AND user_id=?";
        params.push(userId);
    }

    if (action) {
        query += " AND action=?";
        params.push(action);
    }

    if (startDate && endDate) {
        query += " AND timestamp BETWEEN ? AND ?";
        params.push(startDate, endDate);
    }

    query += " ORDER BY timestamp DESC";

    const [logsResult] = await db.query(query, params);
    response.send({ logs: logsResult });
});

// logout
app.post("/api/auth/logout", authMiddleware, async (request, response) => {
    const { orgId, userId } = request.user;

    const action = "user_logout";
    const meta = { user_id: userId,org_id:orgId };

    await addLog(orgId, userId, action, meta);

    response.send({ message: "User logged out successfully" });
});
module.exports=app